<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Character Creation - Dicekeeper</title>
  <link rel="stylesheet" href="../common/header.css">
  <style>
    :root {
      --green-600: #004c3685;
      --white: #ffffff;
    }

    * {
      box-sizing: border-box;
      font-family: system-ui, sans-serif;
      margin: 0;
      padding: 0;
    }

    body {
      background-image: url("../images/Background.png");
      background-size: cover;
      background-attachment: fixed;
      min-height: 100vh;
      padding-top: 80px;
      padding-bottom: 40px;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }

    .card {
      background: var(--green-600);
      border-radius: 24px;
      padding: 26px;
      color: white;
      backdrop-filter: blur(12px);
      margin-bottom: 20px;
    }

    .card-header {
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    }

    .back-link {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      color: rgba(255, 255, 255, 0.7);
      text-decoration: none;
      font-size: 14px;
      margin-bottom: 16px;
      transition: color 0.2s;
    }

    .back-link:hover {
      color: white;
    }

    .card-title {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .card-subtitle {
      font-size: 14px;
      opacity: 0.7;
    }

    /* Steps indicator */
    .steps {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-bottom: 24px;
    }

    .step {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.3);
      transition: background 0.3s, transform 0.3s;
    }

    .step.active {
      background: #81c784;
      transform: scale(1.2);
    }

    .step.completed {
      background: #4caf50;
    }

    /* Form styles */
    .section {
      margin-bottom: 24px;
    }

    .section-title {
      font-size: 13px;
      text-transform: uppercase;
      opacity: 0.7;
      margin-bottom: 12px;
      letter-spacing: 0.5px;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-group label {
      display: block;
      font-size: 12px;
      text-transform: uppercase;
      opacity: 0.85;
      margin-bottom: 6px;
    }

    input[type="text"],
    input[type="number"],
    textarea,
    select {
      width: 100%;
      background: rgba(0, 0, 0, 0.25);
      border: 1px solid rgba(255, 255, 255, 0.5);
      border-radius: 12px;
      padding: 12px 16px;
      color: white;
      font-size: 14px;
      outline: none;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    input:focus,
    textarea:focus,
    select:focus {
      border-color: #38bdf8;
      box-shadow: 0 0 0 2px rgba(56, 189, 248, 0.3);
    }

    input::placeholder,
    textarea::placeholder {
      color: rgba(255, 255, 255, 0.5);
    }

    textarea {
      min-height: 100px;
      resize: vertical;
    }

    select {
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='white' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10l-5 5z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      padding-right: 36px;
    }

    select option {
      background: #1a4a3a;
      color: white;
    }

    /* Selection cards */
    .selection-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 12px;
    }

    .selection-card {
      background: rgba(0, 0, 0, 0.25);
      border: 2px solid transparent;
      border-radius: 16px;
      padding: 16px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }

    .selection-card:hover {
      background: rgba(0, 0, 0, 0.35);
      transform: translateY(-2px);
    }

    .selection-card.selected {
      border-color: #81c784;
      background: rgba(129, 199, 132, 0.15);
    }

    .selection-card-icon {
      width: 48px;
      height: 48px;
      margin: 0 auto 10px;
      border-radius: 50%;
      background: linear-gradient(135deg, #6ee7b7 0%, #34d399 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
    }

    .selection-card-name {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .selection-card-desc {
      font-size: 11px;
      opacity: 0.7;
      line-height: 1.3;
    }

    /* Ability scores */
    .ability-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
    }

    @media (max-width: 600px) {
      .ability-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    .ability-box {
      background: rgba(0, 0, 0, 0.25);
      border-radius: 16px;
      padding: 16px;
      text-align: center;
    }

    .ability-label {
      font-size: 11px;
      text-transform: uppercase;
      opacity: 0.7;
      margin-bottom: 8px;
      letter-spacing: 0.5px;
    }

    .ability-controls {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .ability-btn {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: 1px solid rgba(255, 255, 255, 0.5);
      background: transparent;
      color: white;
      font-size: 18px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .ability-btn:hover:not(:disabled) {
      background: rgba(255, 255, 255, 0.1);
      border-color: white;
    }

    .ability-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }

    .ability-value {
      font-size: 24px;
      font-weight: 700;
      min-width: 40px;
    }

    .ability-modifier {
      font-size: 12px;
      opacity: 0.7;
      margin-top: 4px;
    }

    .points-remaining {
      text-align: center;
      padding: 12px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 12px;
      margin-bottom: 16px;
    }

    .points-remaining-value {
      font-size: 24px;
      font-weight: 700;
      color: #81c784;
    }

    .points-remaining-label {
      font-size: 12px;
      opacity: 0.7;
    }

    /* Navigation buttons */
    .nav-buttons {
      display: flex;
      gap: 12px;
      margin-top: 24px;
    }

    .btn {
      flex: 1;
      padding: 14px 24px;
      border-radius: 999px;
      border: none;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn:hover {
      transform: translateY(-2px);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .btn-primary {
      background: linear-gradient(135deg, #7c3aed 0%, #5b21b6 100%);
      color: white;
    }

    .btn-secondary {
      background: transparent;
      border: 1px solid rgba(255, 255, 255, 0.5);
      color: white;
    }

    .btn-success {
      background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%);
      color: white;
    }

    /* Status */
    .status-message {
      padding: 12px 16px;
      border-radius: 12px;
      margin-bottom: 16px;
      font-size: 14px;
      display: none;
    }

    .status-message.show {
      display: block;
    }

    .status-message.error {
      background: rgba(244, 67, 54, 0.2);
      border: 1px solid rgba(244, 67, 54, 0.5);
      color: #ef5350;
    }

    .status-message.success {
      background: rgba(76, 175, 80, 0.2);
      border: 1px solid rgba(76, 175, 80, 0.5);
      color: #81c784;
    }

    .status-message.info {
      background: rgba(33, 150, 243, 0.2);
      border: 1px solid rgba(33, 150, 243, 0.5);
      color: #64b5f6;
    }

    /* Step content */
    .step-content {
      display: none;
    }

    .step-content.active {
      display: block;
    }

    .loading {
      text-align: center;
      padding: 40px;
      opacity: 0.7;
    }

    /* Character preview */
    .character-preview {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .preview-header {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 16px;
    }

    .preview-avatar {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      background: linear-gradient(135deg, #6ee7b7 0%, #34d399 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      font-weight: 700;
      color: #064e3b;
    }

    .preview-info h3 {
      font-size: 20px;
      margin-bottom: 4px;
    }

    .preview-meta {
      font-size: 13px;
      opacity: 0.7;
    }

    .preview-stats {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 8px;
    }

    @media (max-width: 600px) {
      .preview-stats {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    .preview-stat {
      text-align: center;
      padding: 8px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 8px;
    }

    .preview-stat-label {
      font-size: 10px;
      text-transform: uppercase;
      opacity: 0.6;
    }

    .preview-stat-value {
      font-size: 18px;
      font-weight: 700;
    }
  </style>
</head>
<body class="has-header">
  <div class="container">
    <div class="card">
      <a href="../campaign-creation/Campaigns.html" class="back-link" id="backLink">‚Üê Back</a>

      <div class="card-header">
        <h1 class="card-title">Create Character</h1>
        <p class="card-subtitle" id="stepSubtitle">Step 1: Basic Information</p>
      </div>

      <div class="steps">
        <div class="step active" data-step="1"></div>
        <div class="step" data-step="2"></div>
        <div class="step" data-step="3"></div>
        <div class="step" data-step="4"></div>
      </div>

      <div id="statusMessage" class="status-message"></div>

      <!-- Step 1: Basic Info -->
      <div class="step-content active" id="step1">
        <div class="section">
          <div class="form-group">
            <label for="charName">Character Name</label>
            <input type="text" id="charName" placeholder="Enter your character's name" maxlength="100">
          </div>

          <div class="form-group">
            <label for="charRace">Race</label>
            <select id="charRace">
              <option value="">Select a race...</option>
              <option value="Human">Human</option>
              <option value="Elf">Elf</option>
              <option value="Dwarf">Dwarf</option>
              <option value="Halfling">Halfling</option>
              <option value="Dragonborn">Dragonborn</option>
              <option value="Gnome">Gnome</option>
              <option value="Half-Elf">Half-Elf</option>
              <option value="Half-Orc">Half-Orc</option>
              <option value="Tiefling">Tiefling</option>
            </select>
          </div>

          <div class="form-group">
            <label for="charAlignment">Alignment</label>
            <select id="charAlignment">
              <option value="">Select alignment...</option>
              <option value="Lawful Good">Lawful Good</option>
              <option value="Neutral Good">Neutral Good</option>
              <option value="Chaotic Good">Chaotic Good</option>
              <option value="Lawful Neutral">Lawful Neutral</option>
              <option value="True Neutral">True Neutral</option>
              <option value="Chaotic Neutral">Chaotic Neutral</option>
              <option value="Lawful Evil">Lawful Evil</option>
              <option value="Neutral Evil">Neutral Evil</option>
              <option value="Chaotic Evil">Chaotic Evil</option>
            </select>
          </div>
        </div>

        <div class="nav-buttons">
          <button class="btn btn-secondary" id="cancelBtn">Cancel</button>
          <button class="btn btn-primary" id="nextBtn1">Next: Choose Class</button>
        </div>
      </div>

      <!-- Step 2: Class Selection -->
      <div class="step-content" id="step2">
        <div class="section">
          <div class="section-title">Choose Your Class</div>
          <div class="selection-grid" id="classGrid">
            <div class="loading">Loading classes...</div>
          </div>
        </div>

        <div class="nav-buttons">
          <button class="btn btn-secondary" id="backBtn2">Back</button>
          <button class="btn btn-primary" id="nextBtn2" disabled>Next: Background</button>
        </div>
      </div>

      <!-- Step 3: Background Selection -->
      <div class="step-content" id="step3">
        <div class="section">
          <div class="section-title">Choose Your Background</div>
          <div class="selection-grid" id="backgroundGrid">
            <div class="loading">Loading backgrounds...</div>
          </div>
        </div>

        <div class="form-group" style="margin-top: 20px;">
          <label for="charBackstory">Backstory (Optional)</label>
          <textarea id="charBackstory" placeholder="Write your character's backstory..."></textarea>
        </div>

        <div class="nav-buttons">
          <button class="btn btn-secondary" id="backBtn3">Back</button>
          <button class="btn btn-primary" id="nextBtn3" disabled>Next: Ability Scores</button>
        </div>
      </div>

      <!-- Step 4: Ability Scores -->
      <div class="step-content" id="step4">
        <div class="section">
          <div class="section-title">Assign Ability Scores</div>

          <div class="points-remaining">
            <div class="points-remaining-value" id="pointsRemaining">27</div>
            <div class="points-remaining-label">Points Remaining</div>
          </div>

          <div class="ability-grid" id="abilityGrid">
            <!-- Will be populated by JS -->
          </div>
        </div>

        <div class="nav-buttons">
          <button class="btn btn-secondary" id="backBtn4">Back</button>
          <button class="btn btn-success" id="createBtn">Create Character</button>
        </div>
      </div>

      <!-- Step 5: Summary / Complete -->
      <div class="step-content" id="step5">
        <div class="character-preview" id="characterPreview">
          <!-- Will be populated by JS -->
        </div>

        <div class="status-message success show" style="text-align: center;">
          <strong>Character Created!</strong><br>
          Your character is ready for adventure.
        </div>

        <div class="nav-buttons">
          <button class="btn btn-secondary" id="createAnotherBtn">Create Another</button>
          <button class="btn btn-success" id="doneBtn">Done</button>
        </div>
      </div>
    </div>
  </div>

  <script src="../common/header.js" defer></script>
  <script>
    (function() {
      // State
      let currentStep = 1;
      let characterId = null;
      let selectedClassId = null;
      let selectedBackgroundId = null;
      let classes = [];
      let backgrounds = [];
      let abilities = [];
      let abilityScores = {};
      let totalPoints = 27;
      let campaignId = null;

      // Get URL params
      const params = new URLSearchParams(window.location.search);
      campaignId = params.get('campaignId');
      const editId = params.get('id');

      // Elements
      const statusEl = document.getElementById('statusMessage');
      const stepSubtitle = document.getElementById('stepSubtitle');
      const backLink = document.getElementById('backLink');

      // Update back link based on context
      if (campaignId) {
        backLink.href = '../campaign-creation/CharacterSelect.html?campaignId=' + campaignId;
        backLink.textContent = '‚Üê Back to Character Selection';
      }

      function getPlayer() {
        try {
          const raw = sessionStorage.getItem('player');
          return raw ? JSON.parse(raw) : null;
        } catch (e) {
          return null;
        }
      }

      function showStatus(msg, type = 'info') {
        statusEl.textContent = msg;
        statusEl.className = 'status-message show ' + type;
      }

      function hideStatus() {
        statusEl.className = 'status-message';
      }

      function updateStepIndicators() {
        document.querySelectorAll('.step').forEach((el, idx) => {
          el.classList.remove('active', 'completed');
          if (idx + 1 < currentStep) {
            el.classList.add('completed');
          } else if (idx + 1 === currentStep) {
            el.classList.add('active');
          }
        });

        document.querySelectorAll('.step-content').forEach((el, idx) => {
          el.classList.toggle('active', idx + 1 === currentStep);
        });

        const subtitles = [
          'Step 1: Basic Information',
          'Step 2: Choose Your Class',
          'Step 3: Choose Your Background',
          'Step 4: Assign Ability Scores',
          'Character Complete!'
        ];
        stepSubtitle.textContent = subtitles[currentStep - 1] || '';
      }

      function goToStep(step) {
        currentStep = step;
        updateStepIndicators();
        hideStatus();
      }

      // Step 1: Basic Info
      const charNameInput = document.getElementById('charName');
      const charRaceSelect = document.getElementById('charRace');
      const charAlignmentSelect = document.getElementById('charAlignment');

      document.getElementById('cancelBtn').addEventListener('click', () => {
        if (campaignId) {
          window.location.href = '../campaign-creation/CharacterSelect.html?campaignId=' + campaignId;
        } else {
          window.location.href = '../campaign-creation/Campaigns.html';
        }
      });

      document.getElementById('nextBtn1').addEventListener('click', async () => {
        const name = charNameInput.value.trim();
        if (!name) {
          showStatus('Please enter a character name', 'error');
          charNameInput.focus();
          return;
        }

        const race = charRaceSelect.value;
        const alignment = charAlignmentSelect.value;

        const player = getPlayer();
        if (!player) {
          showStatus('Not logged in', 'error');
          return;
        }

        // Create character if not exists
        if (!characterId) {
          showStatus('Creating character...', 'info');
          try {
            // First create an initial empty character
            const createRes = await fetch('/api/character/createInitialCharacter', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' }
            });

            if (!createRes.ok) {
              throw new Error(await createRes.text() || 'Failed to create character');
            }

            const character = await createRes.json();
            characterId = character.id;

            // Now update with the actual data
            const updateRes = await fetch('/api/character/' + characterId, {
              method: 'PATCH',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                name: name,
                level: 1,
                race: race || null,
                alignment: alignment || null
              })
            });

            if (!updateRes.ok) {
              throw new Error(await updateRes.text() || 'Failed to update character');
            }

            hideStatus();
          } catch (err) {
            showStatus('Error: ' + err.message, 'error');
            return;
          }
        } else {
          // Update existing character
          try {
            await fetch('/api/character/' + characterId, {
              method: 'PATCH',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                name: name,
                race: race || null,
                alignment: alignment || null
              })
            });
          } catch (err) {
            console.error('Failed to update character', err);
          }
        }

        goToStep(2);
        loadClasses();
      });

      // Step 2: Class Selection
      async function loadClasses() {
        const grid = document.getElementById('classGrid');
        try {
          const res = await fetch('/api/classes');
          if (!res.ok) throw new Error('Failed to load classes');
          classes = await res.json();

          grid.innerHTML = '';
          classes.forEach(cls => {
            const card = document.createElement('div');
            card.className = 'selection-card' + (selectedClassId === cls.id ? ' selected' : '');
            card.innerHTML = `
              <div class="selection-card-icon">‚öîÔ∏è</div>
              <div class="selection-card-name">${escapeHtml(cls.name)}</div>
              <div class="selection-card-desc">${escapeHtml(cls.description || '').substring(0, 50)}${cls.description && cls.description.length > 50 ? '...' : ''}</div>
            `;
            card.addEventListener('click', () => selectClass(cls.id, card));
            grid.appendChild(card);
          });
        } catch (err) {
          grid.innerHTML = '<p style="opacity:0.7">Failed to load classes</p>';
          console.error(err);
        }
      }

      function selectClass(classId, cardEl) {
        selectedClassId = classId;
        document.querySelectorAll('#classGrid .selection-card').forEach(c => c.classList.remove('selected'));
        cardEl.classList.add('selected');
        document.getElementById('nextBtn2').disabled = false;
      }

      document.getElementById('backBtn2').addEventListener('click', () => goToStep(1));

      document.getElementById('nextBtn2').addEventListener('click', async () => {
        if (!selectedClassId) {
          showStatus('Please select a class', 'error');
          return;
        }

        // Save class to character
        try {
          await fetch('/api/character/' + characterId, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ classId: selectedClassId })
          });
        } catch (err) {
          console.error('Failed to save class', err);
        }

        goToStep(3);
        loadBackgrounds();
      });

      // Step 3: Background Selection
      async function loadBackgrounds() {
        const grid = document.getElementById('backgroundGrid');
        try {
          const res = await fetch('/api/background/all');
          if (!res.ok) throw new Error('Failed to load backgrounds');
          backgrounds = await res.json();

          grid.innerHTML = '';
          backgrounds.forEach(bg => {
            const card = document.createElement('div');
            card.className = 'selection-card' + (selectedBackgroundId === bg.id ? ' selected' : '');
            card.innerHTML = `
              <div class="selection-card-icon">üìú</div>
              <div class="selection-card-name">${escapeHtml(bg.name)}</div>
              <div class="selection-card-desc">${escapeHtml(bg.description || '').substring(0, 50)}${bg.description && bg.description.length > 50 ? '...' : ''}</div>
            `;
            card.addEventListener('click', () => selectBackground(bg.id, card));
            grid.appendChild(card);
          });

          // Enable next if no backgrounds (optional step)
          if (backgrounds.length === 0) {
            document.getElementById('nextBtn3').disabled = false;
          }
        } catch (err) {
          grid.innerHTML = '<p style="opacity:0.7">No backgrounds available</p>';
          document.getElementById('nextBtn3').disabled = false;
          console.error(err);
        }
      }

      function selectBackground(bgId, cardEl) {
        selectedBackgroundId = bgId;
        document.querySelectorAll('#backgroundGrid .selection-card').forEach(c => c.classList.remove('selected'));
        cardEl.classList.add('selected');
        document.getElementById('nextBtn3').disabled = false;
      }

      document.getElementById('backBtn3').addEventListener('click', () => goToStep(2));

      document.getElementById('nextBtn3').addEventListener('click', async () => {
        // Save background and backstory
        const backstory = document.getElementById('charBackstory').value.trim();
        try {
          await fetch('/api/character/' + characterId, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              backgroundId: selectedBackgroundId || null,
              backstory: backstory || null
            })
          });
        } catch (err) {
          console.error('Failed to save background', err);
        }

        goToStep(4);
        loadAbilities();
      });

      // Step 4: Ability Scores
      async function loadAbilities() {
        const grid = document.getElementById('abilityGrid');
        try {
          const res = await fetch('/api/ability/all');
          if (!res.ok) throw new Error('Failed to load abilities');
          abilities = await res.json();

          // Initialize scores
          abilities.forEach(ab => {
            if (!abilityScores[ab.id]) {
              abilityScores[ab.id] = 8; // Default starting value
            }
          });

          renderAbilityGrid();
        } catch (err) {
          grid.innerHTML = '<p style="opacity:0.7">Failed to load abilities</p>';
          console.error(err);
        }
      }

      function renderAbilityGrid() {
        const grid = document.getElementById('abilityGrid');
        grid.innerHTML = '';

        abilities.forEach(ab => {
          const score = abilityScores[ab.id] || 8;
          const modifier = Math.floor((score - 10) / 2);
          const modStr = modifier >= 0 ? '+' + modifier : modifier.toString();

          const box = document.createElement('div');
          box.className = 'ability-box';
          box.innerHTML = `
            <div class="ability-label">${escapeHtml(ab.name.substring(0, 3).toUpperCase())}</div>
            <div class="ability-controls">
              <button class="ability-btn" data-id="${ab.id}" data-action="dec">‚àí</button>
              <div class="ability-value" id="ability-${ab.id}">${score}</div>
              <button class="ability-btn" data-id="${ab.id}" data-action="inc">+</button>
            </div>
            <div class="ability-modifier">${modStr}</div>
          `;
          grid.appendChild(box);
        });

        // Add event listeners
        grid.querySelectorAll('.ability-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const id = parseInt(btn.dataset.id);
            const action = btn.dataset.action;
            adjustAbility(id, action === 'inc' ? 1 : -1);
          });
        });

        updatePointsDisplay();
      }

      function adjustAbility(abilityId, delta) {
        const current = abilityScores[abilityId] || 8;
        const newVal = current + delta;

        // Constraints: 8-15 range, and points available
        if (newVal < 8 || newVal > 15) return;

        const pointCost = calculatePointCost(newVal) - calculatePointCost(current);
        const remaining = getRemainingPoints();

        if (pointCost > remaining) return;

        abilityScores[abilityId] = newVal;
        renderAbilityGrid();
      }

      function calculatePointCost(score) {
        // Point buy costs: 8=0, 9=1, 10=2, 11=3, 12=4, 13=5, 14=7, 15=9
        const costs = { 8: 0, 9: 1, 10: 2, 11: 3, 12: 4, 13: 5, 14: 7, 15: 9 };
        return costs[score] || 0;
      }

      function getTotalPointsUsed() {
        return Object.values(abilityScores).reduce((sum, score) => sum + calculatePointCost(score), 0);
      }

      function getRemainingPoints() {
        return totalPoints - getTotalPointsUsed();
      }

      function updatePointsDisplay() {
        const remaining = getRemainingPoints();
        document.getElementById('pointsRemaining').textContent = remaining;
        document.getElementById('pointsRemaining').style.color = remaining < 0 ? '#ef5350' : '#81c784';
      }

      document.getElementById('backBtn4').addEventListener('click', () => goToStep(3));

      document.getElementById('createBtn').addEventListener('click', async () => {
        const btn = document.getElementById('createBtn');
        btn.disabled = true;
        btn.textContent = 'Creating...';
        showStatus('Saving character...', 'info');

        try {
          // Save ability scores using the correct endpoint
          for (const [abilityId, score] of Object.entries(abilityScores)) {
            await fetch(`/api/character-ability/${characterId}/${abilityId}`, {
              method: 'PATCH',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ score: score })
            });
          }

          // Load final character data
          const charRes = await fetch('/api/character/' + characterId);
          const character = await charRes.json();

          renderCharacterPreview(character);
          goToStep(5);
        } catch (err) {
          showStatus('Error saving character: ' + err.message, 'error');
          btn.disabled = false;
          btn.textContent = 'Create Character';
        }
      });

      function renderCharacterPreview(character) {
        const preview = document.getElementById('characterPreview');
        const className = classes.find(c => c.id === selectedClassId)?.name || 'Unknown';
        const bgName = backgrounds.find(b => b.id === selectedBackgroundId)?.name || 'None';

        const initials = (character.name || 'C').substring(0, 2).toUpperCase();

        preview.innerHTML = `
          <div class="preview-header">
            <div class="preview-avatar">${initials}</div>
            <div class="preview-info">
              <h3>${escapeHtml(character.name || 'Unnamed')}</h3>
              <div class="preview-meta">Level 1 ${escapeHtml(character.race || '')} ${escapeHtml(className)}</div>
            </div>
          </div>
          <div class="preview-stats">
            ${abilities.map(ab => `
              <div class="preview-stat">
                <div class="preview-stat-label">${ab.name.substring(0, 3).toUpperCase()}</div>
                <div class="preview-stat-value">${abilityScores[ab.id] || 8}</div>
              </div>
            `).join('')}
          </div>
        `;
      }

      // Step 5: Done
      document.getElementById('createAnotherBtn').addEventListener('click', () => {
        // Reset state
        characterId = null;
        selectedClassId = null;
        selectedBackgroundId = null;
        abilityScores = {};
        charNameInput.value = '';
        charRaceSelect.value = '';
        charAlignmentSelect.value = '';
        document.getElementById('charBackstory').value = '';
        document.getElementById('nextBtn2').disabled = true;
        document.getElementById('nextBtn3').disabled = true;
        goToStep(1);
      });

      document.getElementById('doneBtn').addEventListener('click', () => {
        if (campaignId) {
          window.location.href = '../campaign-creation/CharacterSelect.html?campaignId=' + campaignId;
        } else {
          window.location.href = '../campaign-creation/Campaigns.html';
        }
      });

      function escapeHtml(str) {
        if (!str) return '';
        return String(str)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;');
      }

      // Initialize
      updateStepIndicators();

      // If editing existing character, load it
      if (editId) {
        characterId = editId;
        // Could load existing data here
      }
    })();
  </script>
</body>
</html>
