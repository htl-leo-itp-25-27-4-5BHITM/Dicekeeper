<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Profil</title>
  <style>
    :root {
      --green-600: #004c3685;
      --green-700: #256628;
      --green-300: #81c784;
      --white: #ffffff;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      background-image: url("../images/Background.png");
      background-size: cover;
      background-attachment: fixed;
      background-blend-mode: lighten;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
    }

    .card {
      background: var(--green-600);
      border-radius: 24px;
      padding: 32px 36px;
      max-width: 480px;
      width: 100%;
      box-shadow: 0 24px 60px rgba(0, 0, 0, 0.65);
      border: 1px solid rgba(148, 163, 184, 0.3);
      color: var(--white);
    }

    .card-header {
      text-align: center;
      margin-bottom: 28px;
    }

    .card-title {
      font-size: 24px;
      font-weight: 600;
      letter-spacing: 0.04em;
    }

    /* Profile Picture Section */
    .profile-section {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 28px;
    }

    .profile-avatar {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background: linear-gradient(135deg, #6ee7b7 0%, #34d399 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 42px;
      color: #064e3b;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
      overflow: hidden;
      margin-bottom: 16px;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      position: relative;
    }

    .profile-avatar:hover {
      transform: scale(1.05);
      box-shadow: 0 12px 32px rgba(0, 0, 0, 0.4);
    }

    .profile-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .profile-avatar-overlay {
      position: absolute;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.2s;
      border-radius: 50%;
    }

    .profile-avatar:hover .profile-avatar-overlay {
      opacity: 1;
    }

    .profile-avatar-overlay span {
      color: white;
      font-size: 14px;
      font-weight: 500;
    }

    .profile-email {
      font-size: 14px;
      color: rgba(255, 255, 255, 0.7);
    }

    /* Form Styles */
    .form-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-bottom: 20px;
    }

    label {
      font-size: 13px;
      color: #e5e7eb;
      letter-spacing: 0.06em;
      text-transform: uppercase;
    }

    input[type="text"] {
      background: #004c3670;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.903);
      padding: 12px 18px;
      color: #ffffff;
      font-size: 15px;
      outline: none;
      transition: border-color 0.2s, box-shadow 0.2s, background 0.2s;
    }

    input:focus {
      border-color: #38bdf8;
      box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.6);
      background: #004c36d2;
    }

    input::placeholder {
      color: rgba(255, 255, 255, 0.6);
    }

    /* Buttons */
    .btn {
      border-radius: 999px;
      padding: 12px 24px;
      font-size: 14px;
      border: 1px solid transparent;
      background: transparent;
      color: #ffffff;
      cursor: pointer;
      transition: background 0.2s, color 0.2s, border-color 0.2s, transform 0.1s;
      font-weight: 500;
    }

    .btn:active {
      transform: scale(0.98);
    }

    .btn-primary {
      background: #7708c7b8;
      color: #ffffff;
      font-weight: 600;
      box-shadow: 0 0 20px rgba(168, 85, 247, 0.4);
      width: 100%;
      margin-bottom: 12px;
    }

    .btn-primary:hover {
      filter: brightness(1.1);
    }

    .btn-primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .btn-secondary {
      border-color: rgba(255, 255, 255, 0.5);
      width: 100%;
      margin-bottom: 12px;
    }

    .btn-secondary:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .btn-danger {
      background: rgba(239, 68, 68, 0.2);
      border-color: rgba(239, 68, 68, 0.5);
      color: #fca5a5;
      width: 100%;
    }

    .btn-danger:hover {
      background: rgba(239, 68, 68, 0.35);
      border-color: rgba(239, 68, 68, 0.7);
    }

    .divider {
      display: flex;
      align-items: center;
      margin: 24px 0;
    }

    .divider::before,
    .divider::after {
      content: "";
      flex: 1;
      height: 1px;
      background-color: rgba(255, 255, 255, 0.3);
    }

    .divider span {
      margin: 0 12px;
      font-size: 12px;
      color: rgba(255, 255, 255, 0.6);
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }

    #status {
      margin-top: 16px;
      font-size: 0.9rem;
      text-align: center;
      min-height: 24px;
    }

    .status-success {
      color: #86efac;
    }

    .status-error {
      color: #f97373;
    }

    .status-info {
      color: #98a2b3;
    }

    /* Hidden file input */
    #profilePicInput {
      display: none;
    }

    /* Back link */
    .back-link {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      color: rgba(255, 255, 255, 0.7);
      text-decoration: none;
      font-size: 14px;
      margin-bottom: 20px;
      transition: color 0.2s;
    }

    .back-link:hover {
      color: white;
    }

    @media (max-width: 520px) {
      .card {
        margin: 16px;
        padding: 24px 20px;
      }

      .profile-avatar {
        width: 100px;
        height: 100px;
        font-size: 36px;
      }
    }
  </style>
</head>
<body>
  <div class="card">
    <a href="./Campaigns.html" class="back-link">← Zurück zu Kampagnen</a>

    <div class="card-header">
      <div class="card-title">Profil</div>
    </div>

    <div class="profile-section">
      <div class="profile-avatar" id="profileAvatar" title="Klicke um Profilbild zu ändern">
        <span id="avatarInitials">?</span>
        <img id="avatarImage" src="" alt="Profilbild" style="display: none;" />
        <div class="profile-avatar-overlay">
          <span>Ändern</span>
        </div>
      </div>
      <input type="file" id="profilePicInput" accept="image/png,image/jpeg,image/jpg,image/svg+xml" />
      <div class="profile-email" id="profileEmail">-</div>
    </div>

    <div class="form-group">
      <label for="username">Benutzername</label>
      <input type="text" id="username" placeholder="Dein Benutzername" maxlength="50" />
    </div>

    <div class="form-group">
      <label for="displayName">Anzeigename</label>
      <input type="text" id="displayName" placeholder="Dein Anzeigename" maxlength="100" />
    </div>

    <button class="btn btn-primary" id="saveBtn">Änderungen speichern</button>
    <button class="btn btn-secondary" id="backBtn">Abbrechen</button>

    <div class="divider">
      <span>Session</span>
    </div>

    <button class="btn btn-danger" id="logoutBtn">Abmelden</button>

    <div id="status" class="status-info"></div>
  </div>

  <script>
    (function () {
      const avatarEl = document.getElementById('profileAvatar');
      const avatarInitials = document.getElementById('avatarInitials');
      const avatarImage = document.getElementById('avatarImage');
      const profilePicInput = document.getElementById('profilePicInput');
      const profileEmail = document.getElementById('profileEmail');
      const usernameInput = document.getElementById('username');
      const displayNameInput = document.getElementById('displayName');
      const saveBtn = document.getElementById('saveBtn');
      const backBtn = document.getElementById('backBtn');
      const logoutBtn = document.getElementById('logoutBtn');
      const statusEl = document.getElementById('status');

      let currentPlayer = null;

      function setStatus(msg, type = 'info') {
        statusEl.textContent = msg || '';
        statusEl.className = 'status-' + type;
      }

      function initialsFromName(name) {
        if (!name) return '?';
        const parts = name.trim().split(/\s+/);
        if (parts.length === 1) return parts[0].slice(0, 2).toUpperCase();
        return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
      }

      function updateAvatarDisplay(player) {
        if (player.profilePicture) {
          let imgUrl = player.profilePicture;
          if (imgUrl.startsWith('/uploads/')) {
            imgUrl = '..' + imgUrl;
          }
          avatarImage.src = imgUrl;
          avatarImage.style.display = 'block';
          avatarInitials.style.display = 'none';
        } else {
          avatarImage.style.display = 'none';
          avatarInitials.style.display = 'block';
          avatarInitials.textContent = initialsFromName(player.name || player.username || player.email);
        }
      }

      function loadPlayer() {
        try {
          const raw = sessionStorage.getItem('player');
          if (!raw) {
            setStatus('Nicht eingeloggt. Weiterleitung...', 'error');
            setTimeout(() => {
              window.location.href = './Login.html';
            }, 1500);
            return null;
          }
          return JSON.parse(raw);
        } catch (e) {
          console.error('Failed to parse player from session', e);
          setStatus('Session-Fehler. Bitte erneut anmelden.', 'error');
          return null;
        }
      }

      async function fetchLatestPlayer(playerId) {
        try {
          const res = await fetch('/api/player/id/' + encodeURIComponent(playerId), { cache: 'no-store' });
          if (res.ok) {
            return await res.json();
          }
        } catch (e) {
          console.warn('Could not fetch latest player data', e);
        }
        return null;
      }

      async function init() {
        currentPlayer = loadPlayer();
        if (!currentPlayer) return;

        // Fetch latest data from server
        const latestPlayer = await fetchLatestPlayer(currentPlayer.id);
        if (latestPlayer) {
          currentPlayer = latestPlayer;
          sessionStorage.setItem('player', JSON.stringify(currentPlayer));
        }

        // Populate form
        profileEmail.textContent = currentPlayer.email || '-';
        usernameInput.value = currentPlayer.username || '';
        displayNameInput.value = currentPlayer.name || '';
        updateAvatarDisplay(currentPlayer);
      }

      // Avatar click -> open file picker
      avatarEl.addEventListener('click', () => {
        profilePicInput.click();
      });

      // Handle file selection
      profilePicInput.addEventListener('change', async (e) => {
        const file = e.target.files && e.target.files[0];
        if (!file) return;

        if (!currentPlayer || !currentPlayer.id) {
          setStatus('Kein Spieler geladen', 'error');
          return;
        }

        // Validate file type
        const validTypes = ['image/jpeg', 'image/png', 'image/svg+xml'];
        if (!validTypes.includes(file.type)) {
          setStatus('Nur JPG, PNG oder SVG erlaubt', 'error');
          return;
        }

        // Validate file size (max 5MB)
        if (file.size > 5 * 1024 * 1024) {
          setStatus('Datei zu groß (max 5MB)', 'error');
          return;
        }

        setStatus('Lade Profilbild hoch...', 'info');

        const formData = new FormData();
        formData.append('file', file);

        try {
          const res = await fetch('/api/player/' + currentPlayer.id + '/upload-profile-picture', {
            method: 'POST',
            body: formData
          });

          if (!res.ok) {
            let txt = '';
            try { txt = await res.text(); } catch (err) {}
            throw new Error(txt || res.statusText || 'Upload fehlgeschlagen');
          }

          const updatedPlayer = await res.json();
          currentPlayer = updatedPlayer;
          sessionStorage.setItem('player', JSON.stringify(currentPlayer));
          updateAvatarDisplay(currentPlayer);
          setStatus('Profilbild aktualisiert!', 'success');
        } catch (err) {
          console.error('Profile picture upload failed', err);
          setStatus('Upload fehlgeschlagen: ' + (err.message || 'Unbekannt'), 'error');
        }
      });

      // Save button
      saveBtn.addEventListener('click', async () => {
        if (!currentPlayer || !currentPlayer.id) {
          setStatus('Kein Spieler geladen', 'error');
          return;
        }

        const newUsername = usernameInput.value.trim();
        const newName = displayNameInput.value.trim();

        if (!newUsername && !newName) {
          setStatus('Bitte mindestens ein Feld ausfüllen', 'error');
          return;
        }

        saveBtn.disabled = true;
        const origText = saveBtn.textContent;
        saveBtn.textContent = 'Speichern...';
        setStatus('Speichere Änderungen...', 'info');

        try {
          const payload = {};
          if (newUsername) payload.username = newUsername;
          if (newName) payload.name = newName;

          const res = await fetch('/api/player/' + currentPlayer.id, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });

          if (!res.ok) {
            let txt = '';
            try { txt = await res.text(); } catch (err) {}
            throw new Error(txt || res.statusText || 'Speichern fehlgeschlagen');
          }

          const updatedPlayer = await res.json();
          currentPlayer = updatedPlayer;
          sessionStorage.setItem('player', JSON.stringify(currentPlayer));
          updateAvatarDisplay(currentPlayer);
          setStatus('Profil gespeichert!', 'success');
        } catch (err) {
          console.error('Save failed', err);
          setStatus('Speichern fehlgeschlagen: ' + (err.message || 'Unbekannt'), 'error');
        } finally {
          saveBtn.disabled = false;
          saveBtn.textContent = origText;
        }
      });

      // Back button
      backBtn.addEventListener('click', () => {
        window.location.href = './Campaigns.html';
      });

      // Logout button
      logoutBtn.addEventListener('click', () => {
        sessionStorage.removeItem('player');
        setStatus('Abgemeldet. Weiterleitung...', 'success');
        setTimeout(() => {
          window.location.href = './Login.html';
        }, 1000);
      });

      // Initialize
      init();
    })();
  </script>
</body>
</html>

